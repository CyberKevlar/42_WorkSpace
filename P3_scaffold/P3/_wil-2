#!/bin/sh
set -eux

# === Underlay IP en eth1
ip addr add 10.1.1.12/24 dev eth1 || true
ip link set dev eth1 up

# === Bridge L2 para el VXLAN (br0)
ip link add br0 type bridge || true
ip link set dev br0 up

# === VTEP VXLAN (id 10) gestionado por EVPN (sin remotos/grupo, sin learning)
ip link add name vxlan10 type vxlan id 10 dev eth1 local 10.1.1.12 dstport 4789 nolearning || true
ip link set dev vxlan10 up

# === Acceso (lado host)
ip link set dev eth0 up

# === Bridge membership
ip link set dev eth0 master br0
ip link set dev vxlan10 master br0

# === FRR: crear configs EVPN/OSPF y (re)iniciar daemons
mkdir -p /etc/frr

cat > /etc/frr/zebra.conf <<'EOF'
hostname _wil-2_zebra
service integrated-vtysh-config
log syslog
EOF

cat > /etc/frr/ospfd.conf <<'EOF'
hostname _wil-2_ospfd
router ospf
  ospf router-id 10.1.1.12
  network 10.1.1.0/24 area 0
log syslog
EOF

cat > /etc/frr/bgpd.conf <<'EOF'
frr defaults traditional
hostname _wil-2_bgpd
router bgp 65000
  bgp router-id 10.1.1.12
  neighbor RR peer-group
  neighbor RR remote-as 65000
  neighbor RR update-source eth1
  neighbor 10.1.1.254 peer-group RR

  address-family l2vpn evpn
    neighbor 10.1.1.254 activate
    advertise-all-vni
  exit-address-family

evpn
  vni 10
    rd 10:10
    route-target import 10:10
    route-target export 10:10
log syslog
EOF

# Reiniciar/arrancar servicios (tolerante a distintas imágenes)
(pkill bgpd || true); (pkill ospfd || true); (pkill zebra || true)
(zebra -d || true)
(ospfd -d || true)
(bgpd -d || true)

# Notas de verificación
echo "Comandos útiles: vtysh -c 'show evpn vni', vtysh -c 'show bgp l2vpn evpn route type 2', bridge fdb show"
